<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشغل فيديو + ملخص ذكي + ملاحظات صوتية وصور + إعادة ترتيب</title>
  <style>
    /* --- الأنماط CSS كما هي من الرد السابق مع تعديلات بسيطة للملاحظات --- */
     body {
      text-align: right;
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    #videoContainer, #summaryBox, #transcriptInput, .search-box, .notes-section, .lecture-images-section { /* Added .lecture-images-section */
      width: 90%;
      max-width: 900px;
      margin: 15px auto;
      text-align: right;
      font-size: 16px;
      line-height: 1.8;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
    }
    textarea {
      width: 100%;
      height: 150px;
      font-size: 16px;
      padding: 12px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      transition: background-color 0.3s, color 0.3s;
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: right;
      direction: rtl;
      box-sizing: border-box; /* Added for better width calculation */
      white-space: pre-wrap; /* Preserve whitespace and wrap */
      word-wrap: break-word; /* Break long words */
    }
    input[type="text"] {
      width: 70%;
      padding: 12px;
      margin: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: right;
      direction: rtl;
      box-sizing: border-box; /* Added */
    }
    .control-btn, .record-btn { /* Added .record-btn */
      padding: 12px 20px;
      margin: 5px; /* Adjusted margin */
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      transition: 0.3s;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      vertical-align: middle; /* Align buttons nicely */
    }
    .control-btn:hover, .record-btn:hover {
      background-color: #0056b3;
    }
    .record-btn.recording {
      background-color: #dc3545; /* Red when recording */
    }
    .record-btn.recording:hover {
      background-color: #c82333;
    }
    iframe {
      width: 100%;
      height: 450px;
      border-radius: 8px;
      border: none;
    }
    .floating-controls {
      position: fixed;
      bottom: 25px;
      left: 25px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1000;
    }
    .floating-right-controls {
      position: fixed;
      bottom: 25px;
      right: 25px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1000;
    }
    #notesList {
      list-style-type: none;
      padding: 0;
      width: 90%;
      max-width: 900px;
      margin: 20px auto;
    }
    #notesList li {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0px 1px 3px rgba(0,0,0,0.1);
      text-align: right;
      font-size: 15px;
      line-height: 1.6;
      overflow-wrap: break-word; /* Handle long text */
      word-wrap: break-word; /* Handle long words */
      white-space: pre-wrap; /* Preserve whitespace and wrap */
      position: relative; /* For button positioning */
      display: flex; /* Use flexbox for layout */
      align-items: center; /* Vertically align items */
      cursor: grab; /* Indicate draggable */
      user-select: none; /* Prevent text selection while dragging */
    }
     #notesList li:active {
         cursor: grabbing; /* Indicate dragging state */
     }
    #notesList li audio { /* Style for audio players in notes */
        width: 100%;
        max-width: 300px; /* Limit audio player width */
        margin-top: 10px;
        vertical-align: middle;
        margin-left: 10px; /* Space before buttons */
    }
     /* Drag handle style */
    .drag-handle {
        width: 20px; /* Width of the handle area */
        height: 100%; /* Make handle cover full height */
        margin-left: 15px; /* Space between handle and content */
        cursor: grab; /* Indicate draggable */
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ccc; /* Handle color */
        font-size: 18px;
    }
    #notesList li.dragging {
        opacity: 0.5; /* Reduce opacity of the dragged item */
        transform: rotate(2deg); /* Slight rotation effect */
    }
     #notesList li.drag-over {
         border-top: 2px dashed #007bff; /* Visual cue for drop target */
     }
     #notesList li.drag-over-bottom {
         border-bottom: 2px dashed #007bff; /* Visual cue for drop target */
     }

    .speed-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .speed-btn {
      min-width: 65px;
      padding: 12px;
    }
    .clear-search-btn {
      padding: 12px 18px;
      margin: 10px;
      font-size: 15px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #dc3545;
      color: white;
      transition: 0.3s;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      vertical-align: middle;
    }
    .clear-search-btn:hover {
      background-color: #c82333;
    }
     /* Smaller buttons inside notes list */
     #notesList .control-btn, #notesList .clear-search-btn {
        padding: 3px 8px;
        font-size: 13px;
        margin-right: 5px;
        vertical-align: middle;
        margin-top: 5px; /* Add some top margin */
        /* Position them to the left if needed */
        /* float: left; */
        /* margin-left: 5px; */
     }
     #notesList li b { /* Timestamp style */
        font-weight: bold;
        color: #007bff;
        margin-left: 5px;
        display: inline-block; /* Ensure proper spacing */
     }
     /* Removed specific style for text span to fix wrapping issue */
     /*
     #notesList li span:nth-of-type(2) {
        display: inline-block;
        margin-right: 5px;
        max-width: calc(100% - 250px);
        vertical-align: middle;
     }
     */

    /* Dark Mode Styles */
    .dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    .dark-mode #videoContainer,
    .dark-mode #summaryBox,
    .dark-mode #transcriptInput,
    .dark-mode .search-box,
    .dark-mode .notes-section,
    .dark-mode .lecture-images-section { /* Added .lecture-images-section */
      background-color: #1e1e1e;
      color: #e0e0e0;
      border: 1px solid #333;
    }
    .dark-mode textarea {
      background-color: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #444;
    }
    .dark-mode input[type="text"] {
      background-color: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #444;
    }
    .dark-mode .control-btn, .dark-mode .record-btn { /* Added .record-btn */
      background-color: #444;
      color: #fff;
    }
    .dark-mode .control-btn:hover, .dark-mode .record-btn:hover {
      background-color: #555;
    }
    .dark-mode .record-btn.recording {
        background-color: #a71d2a;
    }
    .dark-mode .record-btn.recording:hover {
        background-color: #8c1a24;
    }
    .dark-mode #notesList li {
      background-color: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #444;
    }
     .dark-mode #notesList li b { /* Timestamp in dark mode */
        color: #4dabf7;
     }
    .dark-mode .clear-search-btn {
      background-color: #a71d2a;
    }
    .dark-mode .clear-search-btn:hover {
      background-color: #8c1a24;
    }
     /* Adjust audio player colors in dark mode if possible (browser dependent) */
     .dark-mode #notesList li audio {
         filter: invert(1) hue-rotate(180deg); /* Basic inversion, might not look perfect */
     }
    .dark-mode .drag-handle {
         color: #555;
    }


    /* Highlight Styles */
    .highlight {
      background-color: yellow;
      color: black;
      padding: 0 3px;
      border-radius: 3px;
    }
    .highlight-line {
      background-color: rgba(255, 255, 0, 0.3);
      border-left: 4px solid yellow;
      padding: 10px;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 0 6px 6px 0;
      position: relative; /* For positioning the jump button inside */
    }
     .highlight-line .control-btn { /* Style jump button inside results */
        padding: 2px 6px !important;
        font-size: 12px !important;
        float: left;
        margin-left: 5px;
        position: absolute;
        left: 5px;
        top: 50%;
        transform: translateY(-50%);
     }
    .highlight-line:hover {
      background-color: rgba(255, 255, 0, 0.5);
    }
    .dark-mode .highlight-line {
        background-color: rgba(255, 255, 0, 0.2);
        border-left-color: #ffd700; /* Gold */
    }
    .dark-mode .highlight-line:hover {
        background-color: rgba(255, 255, 0, 0.3);
    }

    /* Summary Box Styles */
    #summaryBox {
      text-align: right;
      white-space: pre-wrap; /* Preserve whitespace and wrap */
      word-wrap: break-word; /* Break long words */
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.8;
      padding: 20px;
      overflow-wrap: break-word;
      min-height: 100px; /* Ensure some height */
    }
    #summaryBox b { font-weight: bold; color: #007bff; }
    .dark-mode #summaryBox b { color: #4dabf7; }
    #summaryBox i { font-style: italic; }
    #summaryBox u { text-decoration: underline; }
    #summaryBox h2, #summaryBox h3, #summaryBox h4 { /* Style generated headings */
        margin-top: 1.5em; margin-bottom: 0.5em; color: #0056b3;
        border-bottom: 1px solid #eee; padding-bottom: 0.3em;
    }
    .dark-mode #summaryBox h2, .dark-mode #summaryBox h3, .dark-mode #summaryBox h4 {
        color: #66d9e8; border-bottom-color: #444;
    }
    #summaryBox ul, #summaryBox ol { padding-right: 20px; margin-bottom: 1em; }
    #summaryBox code { background-color: #e9ecef; padding: 2px 5px; border-radius: 3px; font-family: monospace; color: #333; direction: ltr; display: inline-block;}
    .dark-mode #summaryBox code { background-color: #3a3a3a; color: #f0f0f0; }
    .note-link { color: #007bff; cursor: pointer; text-decoration: underline; }
    .dark-mode .note-link { color: #4dabf7; }

    /* LaTeX Styles */
    .latex {
      color: #d63384; font-family: "Courier New", monospace;
      background-color: rgba(214, 51, 132, 0.1); padding: 2px 8px;
      border-radius: 4px; font-size: 1.1em; direction: ltr; display: inline-block;
      vertical-align: middle;
    }
    .math-container {
      margin: 20px 0; padding: 15px; background-color: rgba(248, 249, 250, 0.8);
      border-radius: 6px; border-right: 5px solid #d63384; border-left: none; /* Adjust border side */
      overflow-x: auto; text-align: center; direction: ltr;
    }
    .dark-mode .latex { color: #ff6b9e; background-color: rgba(255, 107, 158, 0.1); }
    .dark-mode .math-container { background-color: rgba(30, 30, 30, 0.8); border-right-color: #ff6b9e; }

    /* Image Gallery Styles */
    #imageGallery { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
    #imageGallery .img-container { position: relative; display: inline-block; }
    #imageGallery img {
        display: block; width: 120px; height: 120px; object-fit: cover;
        border-radius: 5px; cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: 1px solid #ddd;
    }
    #imageGallery img:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    #imageGallery .delete-img-btn {
        position: absolute; top: 3px; right: 3px; width: 20px; height: 20px;
        background-color: rgba(220, 53, 69, 0.8); color: white; border: none;
        border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center;
        cursor: pointer; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 1;
    }
    #imageGallery .img-container:hover .delete-img-btn { opacity: 1; }
    .dark-mode #imageGallery img { border: 1px solid #444; }
     .dark-mode #imageGallery .delete-img-btn { background-color: rgba(167, 29, 42, 0.8); }

    /* Image Modal (Lightbox) Styles */
    .modal {
        display: none; position: fixed; z-index: 1500; padding-top: 50px;
        left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
        background-color: rgba(0,0,0,0.85);
    }
    .modal-content { margin: auto; display: block; max-width: 85%; max-height: 85%; }
    .close-modal {
        position: absolute; top: 15px; right: 35px; color: #f1f1f1;
        font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer;
    }
    .close-modal:hover, .close-modal:focus { color: #bbb; text-decoration: none; }
    .modal-nav {
        position: absolute; top: 50%; width: auto; padding: 16px; margin-top: -50px;
        color: white; font-weight: bold; font-size: 30px; transition: 0.3s ease;
        border-radius: 3px; user-select: none; -webkit-user-select: none; cursor: pointer;
        background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-nav:hover { background-color: rgba(0, 0, 0, 0.7); }
    .prev-modal { left: 10px; border-radius: 3px 0 0 3px; } /* Add some spacing */
    .next-modal { right: 10px; border-radius: 0 3px 3px 0; } /* Add some spacing */

    /* Recording Status */
    #recordingStatus { color: red; font-weight: bold; margin-right: 10px; vertical-align: middle; }
    .dark-mode #recordingStatus { color: #ff4d4d; }

     /* General helper for better alignment */
     .center-text { text-align: center; }
     .button-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

    /* Floating Button for Notes */
    #floatingNoteButton {
      position: fixed;
      bottom: 80px;
      right: 25px;
      display: none;
      padding: 15px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 50%;
      background-color: #007bff;
      color: white;
      transition: 0.3s;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      vertical-align: middle;
      z-index: 1000;
    }
    #floatingNoteButton:hover {
      background-color: #0056b3;
    }

    /* Reset Button Style (non-floating) */
    #resetPageBtn {
        display: block; /* Ensure it's a block element */
        width: auto; /* Adjust width as needed */
        margin: 30px auto 20px auto; /* Center and add space */
        padding: 12px 25px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #ff4d4d; /* Red color */
        color: white;
        transition: 0.3s;
        box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
        font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #resetPageBtn:hover {
        background-color: #cc0000; /* Darker red on hover */
    }


  </style>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

  <h2 class="center-text" style="margin-bottom: 15px; color: #007bff;">📺 مشغل فيديو متكامل + تلخيص ذكي + ملاحظات صوتية وصور</h2>
   <p class="center-text" style="margin-top: -10px; margin-bottom: 20px; font-size: 14px; color: #6c757d;">
        ⚠️ لتسجيل الصوت: يجب السماح باستخدام الميكروفون عند الطلب، ويجب تشغيل الصفحة عبر HTTPS أو localhost.
   </p>

  <div class="center-text" style="margin-bottom: 25px;">
    <input type="text" id="videoUrl" placeholder="أدخل رابط فيديو يوتيوب" style="width: 65%; padding: 12px; max-width: 500px;">
    <button class="control-btn" onclick="loadVideo()">🎬 تشغيل الفيديو</button>
  </div>

  <div id="videoContainer"><p class="center-text" style="padding: 20px; color: #6c757d;">أدخل رابط فيديو يوتيوب واضغط "تشغيل الفيديو" للبدء.</p></div>

  <div class="speed-controls">
    <button class="control-btn speed-btn" onclick="changeSpeed(0.5)">0.5x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(0.75)">0.75x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(1)">1x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(1.25)">1.25x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(1.5)">1.5x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(2)">2x</button>
  </div>

  <div class="floating-controls">
    <button class="control-btn" onclick="seek(-10)">⏪ 10ث</button>
    <button class="control-btn" onclick="seek(10)">10ث ⏩</button>
  </div>

  <div class="floating-right-controls">
    <button class="control-btn" id="playPauseBtn" onclick="togglePlayPause()">▶ تشغيل</button>
  </div>

  <div class="notes-section">
    <h3 style="margin-top: 0; color: #17a2b8;">📝 الملاحظات</h3>
    <textarea id="noteText" placeholder="اكتب ملاحظة هنا..." rows="4"></textarea> <div style="margin-top: 10px;"> <button class="control-btn" onclick="saveNote()">💾 حفظ الملاحظة النصية</button>
        <button id="recordNoteBtn" class="record-btn" onclick="toggleRecording()">🎤 تسجيل ريكورد</button>
        <span id="recordingStatus" style="display:none;">🔴 جاري التسجيل...</span>
    </div>
  </div>

  <ul id="notesList"></ul>

  <div class="lecture-images-section">
      <h3 style="margin-top: 0; color: #6f42c1;">🖼️ صور المحاضرة</h3>
      <label for="imageUpload" class="control-btn" style="display: inline-block; margin-bottom: 15px;">➕ إضافة صور</label>
      <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
      <div id="imageGallery">
          </div>
  </div>

  <div id="imageModal" class="modal">
        <span class="close-modal" onclick="closeModal()">×</span>
        <img class="modal-content" id="modalImage">
        <a class="modal-nav prev-modal" onclick="changeModalImage(-1)">❮</a>
        <a class="modal-nav next-modal" onclick="changeModalImage(1)">❯</a>
    </div>

  <div class="search-box">
    <h3 style="margin-top: 0; color: #d63384;">🔍 بحث في محتوى الفيديو</h3>
    <input type="text" id="searchText" placeholder="ابحث في نص الفيديو...">
    <button class="control-btn" onclick="searchInText()">بحث</button>
    <button class="clear-search-btn" onclick="clearSearch()" id="clearSearchBtn" style="display:none;">✖ مسح البحث</button>
    <div id="searchResults" style="margin-top: 15px; text-align: right;"></div>
  </div>

  <div style="margin-top: 25px;" class="notes-section"> <h3 style="margin-bottom: 15px; color: #6f42c1;">📌 النص الكامل (أو الصقه هنا):</h3>
    <textarea id="transcriptInput" placeholder="انتظر جلب الترجمة أو الصق النص الكامل هنا..." style="height: 180px;"></textarea>
    <div style="margin-top:10px; text-align: center;">
        <button class="control-btn" onclick="summarizeText()">📝 توليد ملخص للنص أعلاه</button>
    </div>
  </div>

  <div id="summaryBox" class="notes-section" style="margin-top: 25px; min-height: 150px;">
      <h3 style="margin-top: 0; color: #007bff;">💡 الملخص الذكي</h3>
      <div id="summaryContent">🔍 لم يتم توليد ملخص بعد.</div> </div>

  <div class="center-text button-container" style="margin-top: 30px; padding-bottom: 20px;">
      <button class="control-btn" onclick="toggleDarkMode()" style="padding: 12px 25px;">🌙 تبديل الوضع</button>
      <button id="downloadPageBtn" class="control-btn" onclick="downloadPage()" style="padding: 12px 25px; background-color: #28a745;" title="حفظ الكود الحالي للصفحة بما فيه من ملاحظات وصور كملف HTML واحد">📥 حفظ الصفحة كـ HTML</button>
      <button id="exportBtn" class="control-btn" onclick="exportData()" style="padding: 12px 25px; background-color: #ff9800;">📤 تصدير البيانات</button>
      <button id="importBtn" class="control-btn" onclick="importData()" style="padding: 12px 25px; background-color: #9c27b0;">📥 استرداد البيانات</button>
      <button id="toggleFloatingNoteBtn" class="control-btn" onclick="toggleFloatingNoteButton()" style="padding: 12px 25px; background-color: #e91e63;">🔄 تفعيل الزر العائم</button>
  </div>

  <button id="resetPageBtn" onclick="resetPage()">🧹 إعادة تعيين الصفحة</button>

  <button id="floatingNoteButton" onclick="toggleNotesSection()">📝</button>

  <script>
    const OPENROUTER_API_KEY = "sk-or-v1-e679d438d45b839538f1d42003580b6e1b63d6e78c1c87c77c80f3a9c83add437"; // !!! استبدل بمفتاحك الحقيقي بشكل آمن
    let player;
    let notes = [];
    let captionsData = [];
    let isPlaying = false;
    let currentHighlights = [];
    let lectureImages = [];
    let currentModalIndex = -1;
    let currentVideoUrl = ''; // Added to store the video URL

    // Audio Recording Variables
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let audioStream = null;

    // Drag and Drop variables
    let draggedItem = null;

    // --- YouTube API Handling ---
    function loadYouTubeAPI() {
      if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
        console.log("Loading YouTube API...");
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api"; // Use standard API URL
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      } else {
        console.log("YouTube API already loaded.");
        // If API is already loaded and ready, call onYouTubeIframeAPIReady manually
        if (typeof YT.Player === 'function') {
           onYouTubeIframeAPIReady();
        }
      }
    }
     // This function is called automatically by the YouTube IFrame Player API after the API code downloads.
    function onYouTubeIframeAPIReady() {
      console.log("YouTube IFrame API Ready.");
      // If a video URL was loaded from storage, try to load the video
      if (currentVideoUrl) {
          document.getElementById("videoUrl").value = currentVideoUrl;
          // Add a small delay to ensure the DOM is fully ready for the player div
          setTimeout(() => loadVideo(currentVideoUrl), 100);
      }
    }

    function loadVideo(url) {
      const videoUrlInput = document.getElementById("videoUrl");
      const urlToLoad = url || videoUrlInput.value; // Use provided URL or input value
      if (!urlToLoad) return alert("❌ يرجى إدخال رابط يوتيوب صحيح.");
      const videoId = extractVideoID(urlToLoad);
      if (!videoId) return alert("❌ يرجى إدخال رابط يوتيوب صحيح.");

      currentVideoUrl = urlToLoad; // Save the loaded URL
      saveStateToLocalStorage(); // Save state including the video URL

      if (player && typeof player.destroy === 'function') {
          try { player.destroy(); player = null; console.log("Previous player destroyed.");}
          catch (e) { console.error("Error destroying previous player:", e); }
      }
      // Ensure the player container div exists before creating a new player
       const videoContainer = document.getElementById("videoContainer");
       if (!videoContainer) {
           console.error("Video container element not found!");
           alert("❌ خطأ داخلي: عنصر مشغل الفيديو مفقود.");
           return;
       }
       videoContainer.innerHTML = '<div id="youtubePlayer"></div><p id="playerStatus" style="text-align:center; padding: 10px; color: #6c757d;">⏳ جاري تحميل الفيديو...</p>';

      resetAppState(false); // Clear state but keep notes/images for now, pass false to avoid clearing video URL immediately

      if (typeof YT !== 'undefined' && YT.Player) { createPlayer(videoId); }
      else {
          console.warn("YT API not ready when loadVideo called. Waiting...");
          document.getElementById("playerStatus").innerText = "⏳ واجهة يوتيوب قيد التحميل، يرجى الانتظار...";
           setTimeout(() => {
              if (!player && typeof YT !== 'undefined' && YT.Player) { createPlayer(videoId); }
              else if (!player) {
                   console.error("YT API did not become ready.");
                    const statusEl = document.getElementById("playerStatus");
                    if (statusEl) statusEl.innerText = "❌ فشل تحميل واجهة يوتيوب. حاول تحديث الصفحة.";
                    alert("❌ فشل تحميل واجهة يوتيوب. حاول تحديث الصفحة.");
              }
           }, 4000); // Wait 4 seconds
      }
      fetchTranscript(videoId);
    }
    function createPlayer(videoId) {
        try {
            player = new YT.Player('youtubePlayer', {
                height: '450', width: '100%', videoId: videoId,
                playerVars: { 'playsinline': 1 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange, 'onError': onPlayerError }
            });
            console.log("YT.Player instance requested.");
        } catch (e) {
            console.error("Error creating YT.Player instance:", e);
            const statusEl = document.getElementById("playerStatus");
            if (statusEl) statusEl.innerText = "❌ خطأ في إنشاء مشغل الفيديو.";
            alert("❌ حدث خطأ أثناء تهيئة مشغل الفيديو.");
        }
    }
    function onPlayerReady(event) {
        player = event.target;
        console.log("Player ready (onReady event).");
        const statusEl = document.getElementById("playerStatus");
        if (statusEl) statusEl.remove(); // Remove loading message
        isPlaying = (player.getPlayerState() === YT.PlayerState.PLAYING);
        updatePlayPauseButton();
    }
    function onPlayerError(event) {
        console.error("YouTube Player Error Code:", event.data);
        let errorMsg = `❌ حدث خطأ في مشغل يوتيوب (رمز الخطأ: ${event.data}).`;
        switch(event.data) {
            case 2: errorMsg += " طلب غير صالح."; break;
            case 5: errorMsg += " خطأ في مشغل HTML5."; break;
            case 100: case 101: case 150: errorMsg += " الفيديو غير موجود أو خاص أو لا يمكن تضمينه."; break;
            default: errorMsg += " خطأ غير معروف.";
        }
        document.getElementById("videoContainer").innerHTML = `<p style="color: red; text-align: center; padding: 20px;">${errorMsg}</p>`;
        player = null; isPlaying = false; updatePlayPauseButton();
        currentVideoUrl = ''; // Clear video URL on error
        saveStateToLocalStorage();
    }
    function extractVideoID(url) {
        const regex = /(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|watch(?:\?v=|\/))|youtu\.be\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/;
        return (url.match(regex) || [])[1] || null;
    }
    function onPlayerStateChange(event) {
        isPlaying = (event.data == YT.PlayerState.PLAYING);
        updatePlayPauseButton();
    }
    function togglePlayPause() {
        if (!player || typeof player.getPlayerState !== 'function') return alert("❌ المشغل غير جاهز.");
        try {
            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) player.pauseVideo();
            else player.playVideo();
        } catch (e) { console.error("Error toggling play/pause:", e); alert("❌ خطأ في التشغيل/الإيقاف."); }
    }
    function updatePlayPauseButton() {
        const btn = document.getElementById("playPauseBtn");
        if (btn) btn.innerHTML = isPlaying ? "⏸ إيقاف" : "▶ تشغيل";
    }
    function changeSpeed(speed) {
        if (!player || typeof player.setPlaybackRate !== 'function') return alert("❌ المشغل غير جاهز.");
        try { player.setPlaybackRate(speed); console.log("Playback rate set to:", speed); }
        catch (e) { console.error("Error setting playback rate:", e); alert("❌ خطأ في تغيير السرعة."); }
    }
    function seek(seconds) {
        if (!player || typeof player.seekTo !== 'function') return alert("❌ المشغل غير جاهز.");
        try {
            let currentTime = player.getCurrentTime() || 0;
            let newTime = Math.max(0, currentTime + seconds);
            const duration = player.getDuration();
            if (duration && newTime > duration) newTime = duration;
            player.seekTo(newTime, true);
        } catch (e) { console.error("Error seeking:", e); alert("❌ خطأ في الانتقال."); }
    }

    // --- Transcript & Search ---
    async function fetchTranscript(videoId) { /* ... (as before) ... */
        document.getElementById("transcriptInput").value = "⏳ جاري جلب الترجمة (مثال)...";
        // Simulate fetching transcript
        try {
            await new Promise(resolve => setTimeout(resolve, 500));
            // Using the mock transcript from the new version
            const mockTranscript = `0:05 مرحبًا بكم في الدرس الأول.
0:10 اليوم سنتحدث عن أساسيات الفيزياء الكلاسيكية.
0:15 مقدمة عن الفيزياء.
0:30 التيار الكهربائي (I) هو معدل تدفق الشحنة الكهربائية (Q) خلال الزمن (t).
0:35 هذا يعبر عنه بالقانون التالي:
0:40 \\( I = \\frac{dQ}{dt} \\)
0:45 وحدة قياس التيار هي الأمبير (A).
1:00 الآن، لنتحدث عن قانون أوم.
1:05 ينص قانون أوم على أن الجهد (V) عبر موصل يتناسب طردياً مع التيار (I) المار فيه.
1:15 يمكن كتابة القانون كالتالي:
1:20 \\[ V = I \\times R \\]
1:25 حيث R هي المقاومة وتقاس بالأوم (Ω).
1:30 تطبيقات عملية لهذا القانون مهمة جداً.
1:35 إذا كان لدينا سلك طوله L1 ومساحة مقطعه A1 ومقاومته R1، وعندما يتغير طول السلك إلى \\( L2 = 2L1 \\) ومساحة المقطع إلى \\( A2 = \\frac{A1}{2} \\).
1:45 كيف تتغير المقاومة؟ المقاومة النوعية (\\(\\rho\\)) ثابتة.
1:50 المقاومة الجديدة R2 تُحسب كالتالي:
1:55 \\[ R_2 = \\rho \\frac{L_2}{A_2} = \\rho \\frac{2L_1}{A_1/2} = 4 \\rho \\frac{L_1}{A_1} = 4 R_1 \\]
2:05 إذًا، المقاومة تتضاعف أربع مرات.
2:10 هذا يختتم درسنا اليوم.`;
            captionsData = parseTranscriptWithTimestamps(mockTranscript);
            document.getElementById("transcriptInput").value = mockTranscript;
            renderMathInElement(document.getElementById('transcriptInput'));
        } catch (error) {
            console.error("Error fetching transcript:", error);
            document.getElementById("transcriptInput").value = "⚠️ حدث خطأ أثناء جلب الترجمة، أدخل النص يدويًا.";
            captionsData = [];
        }
    }
    function parseTranscriptWithTimestamps(transcript) { /* ... (as before) ... */
        const lines = transcript.split('\n');
        const data = [];
        const timeRegex = /^(\d{1,2}):(\d{2}(\.\d+)?)/;
        lines.forEach(line => {
            const match = line.match(timeRegex);
            if (match) {
                const minutes = parseInt(match[1], 10);
                const seconds = parseFloat(match[2]);
                const timeInSeconds = (minutes * 60) + seconds;
                const text = line.replace(timeRegex, '').trim();
                if (text) data.push({ time: timeInSeconds, text: text });
            }
        });
        return data;
    }
    function searchInText() { /* ... (as before, check selectors) ... */
        const query = document.getElementById("searchText").value.trim();
        if (!query) return alert("❌ يرجى إدخال نص للبحث");
        const transcriptArea = document.getElementById("transcriptInput");
        const transcript = transcriptArea.value;
        if (!transcript || transcript.includes("⏳") || transcript.includes("⚠️")) {
            return alert("❌ لا يوجد نص صالح للبحث فيه");
        }
        clearSearchHighlights(); // Clear previous highlights
        const lines = transcript.split('\n');
        let resultsHTML = '';
        let foundCount = 0;
        currentHighlights = []; // Reset highlights storage
        const queryLower = query.toLowerCase();

        lines.forEach((line, index) => {
            if (line.toLowerCase().includes(queryLower)) {
                foundCount++;
                const highlightedLineHTML = highlightText(line, query); // For display
                const timestampData = parseTranscriptWithTimestamps(line)[0]; // Check line for timestamp
                let jumpTime = timestampData ? timestampData.time : -1;

                resultsHTML += `<div class="highlight-line" ${jumpTime !== -1 ? `onclick="jumpTo(${jumpTime})"` : ''} title="${jumpTime !== -1 ? 'اضغط للانتقال' : 'لا يوجد طابع زمني لهذا السطر'}">
                    ${highlightedLineHTML}
                    ${jumpTime !== -1 ? `<button class="control-btn" style="padding: 2px 6px !important; font-size: 12px !important;" onclick="event.stopPropagation(); jumpTo(${jumpTime});">🔗 ${formatTime(jumpTime)}</button>` : ''}
                  </div>`;
                currentHighlights.push(index); // Store index of line containing highlight
            }
        });

        const searchResultsDiv = document.getElementById("searchResults");
        if (foundCount > 0) {
            searchResultsDiv.innerHTML = `<p>تم العثور على ${foundCount} نتائج:</p>${resultsHTML}`;
            highlightLinesInTextarea(query); // Highlight first match in textarea
            document.getElementById("clearSearchBtn").style.display = 'inline-block';
        } else {
            searchResultsDiv.innerHTML = "⚠️ لم يتم العثور على نتائج";
            document.getElementById("clearSearchBtn").style.display = 'none';
        }
    }
    function clearSearch() { /* ... (as before) ... */
        clearSearchHighlights();
        document.getElementById("searchResults").innerHTML = '';
        document.getElementById("searchText").value = '';
        document.getElementById("clearSearchBtn").style.display = 'none';
        const textarea = document.getElementById("transcriptInput");
        try { textarea.setSelectionRange(0,0); textarea.scrollTop = 0; } catch(e){}
    }
    function clearSearchHighlights() { /* ... (as before) ... */
         const searchResultsDiv = document.getElementById("searchResults");
         if (searchResultsDiv) {
             searchResultsDiv.querySelectorAll('.highlight').forEach(span => {
                 try { span.outerHTML = span.innerHTML; } catch(e){} // Replace span with its content
             });
        }
        currentHighlights = [];
    }
    function highlightText(text, query) { /* ... (as before) ... */
        if (!query) return text;
        try {
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
             return text.replace(regex, '<span class="highlight">$1</span>');
        } catch (e) { return text; }
    }
    function highlightLinesInTextarea(query) { /* ... (as before) ... */
        const textarea = document.getElementById("transcriptInput");
        const text = textarea.value;
        const queryLower = query.toLowerCase();
        const textLower = text.toLowerCase();
        const startIndex = textLower.indexOf(queryLower);
        if (startIndex !== -1) {
            try {
                textarea.focus();
                textarea.setSelectionRange(startIndex, startIndex + query.length);
                const lineHeight = parseInt(window.getComputedStyle(textarea).lineHeight, 10) || 20;
                const linesAbove = text.substring(0, startIndex).split('\n').length - 1;
                textarea.scrollTop = Math.max(0, linesAbove * lineHeight - textarea.clientHeight / 3);
            } catch (e) { console.error("Error setting selection range:", e); }
        }
    }
    function escapeRegExp(string) { /* ... (as before) ... */
         return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // --- Summarization ---
    async function summarizeText() { /* ... (as before, check summaryContent ID) ... */
         const text = document.getElementById("transcriptInput").value;
          if (!text || text.includes("⏳") || text.includes("⚠️")) {
              return alert("❌ يرجى إدخال نص الترجمة أو الانتظار حتى يتم جلبه.");
          }
          const summaryContainer = document.getElementById("summaryContent"); // Target the inner div
          summaryContainer.innerHTML = "⏳ جاري تلخيص المحتوى باستخدام DeepSeek...";
          try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${OPENROUTER_API_KEY}`, "Content-Type": "application/json",
                "HTTP-Referer": window.location.href, "X-Title": "Video Summarizer Tool",
              },
              body: JSON.stringify({
                "model": "deepseek/deepseek-coder", // Or another suitable model
                "messages": [{
                  "role": "system", "content": `أنت مساعد ذكاء اصطناعي متخصص في تلخيص المحتوى التعليمي، خاصة المحاضرات التقنية. لخص النص بدقة مع الحفاظ على جميع القوانين والمعادلات الرياضية بصيغة LaTeX كما هي تماماً. استخدم العناوين والقوائم لتحسين قابلية القراءة.`
                }, {
                  "role": "user", "content": `لخص النص التالي مع التركيز على النقاط الرئيسية والقوانين والمعادلات الرياضية باستخدام LaTeX:\n\n${text}`
                }]
              })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`فشل طلب التلخيص: ${response.status} ${response.statusText}. ${errorData.error?.message || ''}`);
            }
            const data = await response.json();
            if (!data.choices?.[0]?.message?.content) { throw new Error("لم يتم العثور على محتوى الملخص في استجابة الـ API."); }
            let summary = data.choices[0].message.content;
            summary = processSummaryContent(summary);
            summaryContainer.innerHTML = summary; // Update the inner div
            renderMathInElement(summaryContainer);
            saveStateToLocalStorage();
          } catch (error) {
            summaryContainer.innerHTML = `❌ حدث خطأ أثناء جلب الملخص: ${error.message}`;
            console.error(error);
          }
    }
    function processSummaryContent(summary) { /* ... (as before) ... */
        // Basic markdown to HTML conversion
        summary = summary
          .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') // Bold
          .replace(/\*(.*?)\*/g, '<i>$1</i>') // Italic
          .replace(/`(.*?)`/g, '<code>$1</code>'); // Inline code

        // Handle headings (more robustly)
        summary = summary.replace(/^### (.*$)/gim, '<h4>$1</h4>')
                         .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                         .replace(/^# (.*$)/gim, '<h2>$1</h2>');

        // Handle lists (basic)
        summary = summary.replace(/^\s*-\s+(.*)/gm, '<li>$1</li>') // Unordered list items
                         .replace(/^\s*\d+\.\s+(.*)/gm, '<li>$1</li>'); // Ordered list items

        // Wrap list items in ul/ol (basic, might need refinement for nested lists)
        summary = summary.replace(/((<li>.*?<\/li>\s*)+)/gs, (match) => {
             // Check if list items look like ordered list items (start with digit.)
             const isOrdered = /^\s*\d+\./m.test(match);
             return isOrdered ? `<ol>${match}</ol>` : `<ul>${match}</ul>`;
        });

        // Ensure <br> for newlines, but not inside list items or code blocks
        summary = summary.split('\n').map(line => {
            if (line.trim().startsWith('<li') || line.trim().startsWith('<h') || line.trim() === '' || line.includes('<code>') || line.includes('</code>')) {
                return line; // Don't add <br> for list items, headings, empty lines, or code lines
            }
             // Check if the line is part of a math container or latex span
             if (line.trim().startsWith('<div class="math-container">') || line.trim().startsWith('<span class="latex">')) {
                 return line; // Don't add <br> inside math elements
             }

            return line + '<br>';
        }).join('');


        summary = formatMathEquations(summary); // Process LaTeX after basic formatting

        // Clean up potential extra breaks around block elements like lists and math
         summary = summary.replace(/<br>\s*<(ul|ol|div class="math-container")>/g, '<$1>').replace(/<\/(ul|ol|div class="math-container")>\s*<br>/g, '</$1>');


        return summary;
    }

    function formatMathEquations(text) { /* ... (as before) ... */
        // معالجة المعادلات المستقلة (display style)
        text = text.replace(/\\\[([\s\S]*?)\\\]/g, (m, eq) => `<div class="math-container">\\[${eq.trim()}\\]</div>`);

        // معالجة المعادلات السطرية (inline)
        text = text.replace(/\\\((.*?)\\\)/g, (m, eq) => eq.trim() ? `<span class="latex">\\(${eq.trim()}\\)</span>` : '');

        return text;
    }
    function renderMathInElement(element) { /* ... (as before) ... */
         // Use MathJax to render LaTeX within the specified element
         if (element && (element.innerHTML.includes('\\(') || element.innerHTML.includes('\\['))) {
             if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                // console.log("Rendering MathJax in element:", element.id);
                MathJax.typesetPromise([element]).catch((err) => console.error('MathJax error:', err));
            } else {
                console.warn("MathJax not fully loaded or typesetPromise not available.");
                // Fallback for older MathJax versions or if typesetPromise isn't ready
                if (typeof MathJax !== 'undefined' && MathJax.typeset) {
                     // console.log("Rendering MathJax (fallback) in element:", element.id);
                    MathJax.typeset([element]);
                }
            }
         }
    }


    // --- Notes Management (Fixed Text Wrapping & Added Drag/Drop) ---
    function saveNote() { /* ... (as before) ... */
        const noteTextElement = document.getElementById("noteText");
        const noteText = noteTextElement.value.trim();
        if (!noteText) return alert("❌ يرجى كتابة ملاحظة قبل الحفظ.");
        if (!player || typeof player.getCurrentTime !== 'function') {
             // Allow saving text notes even if player isn't ready, just add a timestamp
             console.warn("Player not ready, saving note with current time estimate or timestamp 0.");
             notes.push({ time: Date.now() / 1000, type: 'text', text: noteText }); // Use current time if player time unavailable
        } else {
            try {
                const currentTime = player.getCurrentTime();
                 // Add new note to the end
                notes.push({ time: currentTime, type: 'text', text: noteText });
            } catch (e) {
                 console.error("Error getting player time for note:", e);
                 notes.push({ time: Date.now() / 1000, type: 'text', text: noteText }); // Fallback to current time
            }
        }

        // No sorting here to keep newest at the bottom after manual saves
        updateNotesList();
        noteTextElement.value = ""; // Clear textarea
        saveStateToLocalStorage();
    }

    // Audio Recording - save audio note
     async function toggleRecording() { /* ... (as before, modified to add to end) ... */
        const recordBtn = document.getElementById('recordNoteBtn');
        const statusIndicator = document.getElementById('recordingStatus');
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return alert('❌ متصفحك لا يدعم تسجيل الصوت.');
        }
        if (!window.isSecureContext) {
             return alert('❌ لا يمكن تسجيل الصوت إلا من صفحة آمنة (HTTPS) أو localhost.');
        }

        if (isRecording) {
            // Stop
            try {
                if (mediaRecorder?.state === "recording") mediaRecorder.stop();
                if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null;
            } catch (e) { console.error("Error stopping recording:", e); }
            finally {
                 recordBtn.classList.remove('recording'); recordBtn.innerHTML = '🎤 تسجيل'; statusIndicator.style.display = 'none'; isRecording = false;
            }
        } else {
            // Start
            if (!player || typeof player.getCurrentTime !== 'function' || typeof player.getPlayerState !== 'function' || player.getPlayerState() === YT.PlayerState.UNSTARTED) {
                 // Allow recording even if player isn't ready, just add a timestamp
                 console.warn("Player not ready, recording note with current time estimate or timestamp 0.");
            }
            let recordingStartTime = 0; // Default to 0 if player time unavailable
            try {
                if(player && typeof player.getCurrentTime === 'function') recordingStartTime = player.getCurrentTime();
            }
            catch(e) { console.error("Faiiled to get player time for recording:", e); }


            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(audioStream); audioChunks = [];
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    if (audioChunks.length === 0) {
                        alert("⚠️ لم يتم تسجيل أي بيانات صوتية.");
                        // Clean up stream if no data was recorded
                         if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null;
                         return;
                    }
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                         // Add new audio note to the end
                        notes.push({ time: recordingStartTime, type: 'audio', data: reader.result });
                        updateNotesList(); saveStateToLocalStorage(); audioChunks = [];
                    };
                    reader.onerror = (error) => { console.error("FileReader error:", error); alert("❌ خطأ في معالجة الصوت."); audioChunks = []; };
                    reader.readAsDataURL(audioBlob);
                     // Clean up stream after successful processing
                     if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null;
                };
                 mediaRecorder.onerror = (event) => {
                     console.error("MediaRecorder Error:", event.error); alert(`❌ خطأ في مسجل الصوت: ${event.error.name}`);
                     if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null; // Ensure stream is stopped on error
                     recordBtn.classList.remove('recording'); recordBtn.innerHTML = '🎤 تسجيل'; statusIndicator.style.display = 'none'; isRecording = false;
                 };
                mediaRecorder.start();
                recordBtn.classList.add('recording'); recordBtn.innerHTML = '⏹ إيقاف'; statusIndicator.style.display = 'inline'; isRecording = true;
            } catch (err) {
                console.error('Error starting recording:', err); isRecording = false;
                recordBtn.classList.remove('recording'); recordBtn.innerHTML = '🎤 تسجيل'; statusIndicator.style.display = 'none';
                if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null; // Ensure stream is stopped on error
                handleRecordingError(err); // Use helper for alerts
            }
        }
    }

    function handleRecordingError(err) { // Helper for specific error messages
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') alert('❌ تم رفض إذن الميكروفون. يرجى السماح به في إعدادات المتصفح.');
        else if (err.name === 'NotFoundError') alert('❌ لم يتم العثور على ميكروفون.');
        else if (err.name === 'NotReadableError') alert('❌ خطأ في قراءة الميكروفون (قد يكون مستخدماً).');
        else if (err.name === 'SecurityError') alert('❌ خطأ أمني (تحقق من HTTPS/localhost).');
        else alert(`❌ خطأ غير متوقع في بدء التسجيل: ${err.name}`);
    }


    function updateNotesList() { /* ... (Modified for Drag/Drop) ... */
        const notesListElement = document.getElementById("notesList");
        notesListElement.innerHTML = "";

        // Sort by time by default (chronological oldest first) unless manually reordered
        // notes.sort((a, b) => a.time - b.time); // Removed default time sort here to allow manual order persistence

        notes.forEach((note, index) => {
            let listItem = document.createElement("li");
            listItem.setAttribute('data-note-index', index);
            listItem.setAttribute('draggable', true); // Make the list item draggable

            // Add drag handle
            const dragHandle = document.createElement('div');
            dragHandle.className = 'drag-handle';
            dragHandle.innerHTML = '⋮'; // Simple drag handle icon

            // Add drag and drop event listeners
            listItem.addEventListener('dragstart', handleDragStart);
            listItem.addEventListener('dragover', handleDragOver);
            listItem.addEventListener('dragleave', handleDragLeave);
            listItem.addEventListener('drop', handleDrop);
            listItem.addEventListener('dragend', handleDragEnd);


            let contentHTML = `<b>[${formatTime(note.time)}]</b> `; // Bold timestamp

            const jumpButton = `<button class="control-btn" onclick="jumpTo(${note.time})">🔗</button>`; // Smaller jump btn
            const deleteButton = `<button class="clear-search-btn" onclick="deleteNote(${index})">🗑️</button>`; // Smaller delete btn

            // Create a container for the note content (text/audio and buttons)
            const contentContainer = document.createElement('div');
            contentContainer.style.flexGrow = 1; // Allow content to take available space

            if (note.type === 'text') {
               // Append text directly, allowing normal text flow
               contentContainer.innerHTML = note.text;
            } else if (note.type === 'audio') {
              contentContainer.innerHTML = `ملاحظة صوتية: <audio controls src="${note.data}"></audio> `;
            }

            listItem.appendChild(dragHandle); // Add handle first
            listItem.appendChild(contentContainer); // Add content container
             // Add buttons inside the content container or next to it as needed
             const buttonDiv = document.createElement('div');
             buttonDiv.appendChild(stringToElement(jumpButton)); // Convert button HTML string to element
             buttonDiv.appendChild(stringToElement(deleteButton));
             buttonDiv.style.marginLeft = 'auto'; // Push buttons to the left (in RTL)
             buttonDiv.style.display = 'flex';
             buttonDiv.style.alignItems = 'center';
             listItem.appendChild(buttonDiv);


            notesListElement.appendChild(listItem);
        });
        renderMathInElement(notesListElement);
    }

     // Helper function to convert HTML string to element
     function stringToElement(htmlString) {
        const div = document.createElement('div');
        div.innerHTML = htmlString.trim();
        return div.firstChild;
     }

    function deleteNote(index) { /* ... (as before) ... */
        if (index < 0 || index >= notes.length) return;
        const noteType = notes[index].type === 'text' ? 'النصية' : 'الصوتية';
        const noteTime = formatTime(notes[index].time);
        if (confirm(`هل أنت متأكد من حذف الملاحظة ${noteType} عند ${noteTime}؟`)) {
            notes.splice(index, 1);
            updateNotesList(); // Update display with new indices
            saveStateToLocalStorage();
        }
    }

    function jumpTo(time) { /* ... (as before) ... */
        if (!player || typeof player.seekTo !== 'function') return alert("❌ المشغل غير جاهز للانتقال.");
        try {
            player.seekTo(time, true);
            if (player.getPlayerState() !== YT.PlayerState.PLAYING) player.playVideo();
        } catch (e) { console.error("Error jumping:", e); alert("❌ خطأ في الانتقال."); }
    }
    function formatTime(seconds) { /* ... (as before) ... */
         seconds = Math.max(0, seconds || 0);
         let min = Math.floor(seconds / 60);
         let sec = Math.floor(seconds % 60);
         return `${min}:${sec < 10 ? "0" : ""}${sec}`;
    }

    // --- Drag and Drop Handlers ---
    function handleDragStart(event) {
        draggedItem = event.target;
        event.dataTransfer.effectAllowed = 'move';
        // Set data for the drag operation (e.g., the index)
        event.dataTransfer.setData('text/plain', event.target.dataset.noteIndex);
         // Add dragging class for visual feedback
        setTimeout(() => { event.target.classList.add('dragging'); }, 0); // Use timeout to allow class to be applied before drag starts
    }

    function handleDragOver(event) {
        event.preventDefault(); // Necessary to allow dropping
        event.dataTransfer.dropEffect = 'move';

        const targetItem = event.target.closest('li');
        if (targetItem && targetItem !== draggedItem) {
            // Remove previous drag-over classes
            document.querySelectorAll('#notesList li').forEach(item => {
                item.classList.remove('drag-over', 'drag-over-bottom');
            });

            // Determine whether to show indicator above or below
            const rect = targetItem.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;

            if (event.clientY < midpoint) {
                targetItem.classList.add('drag-over'); // Indicate drop above
            } else {
                targetItem.classList.add('drag-over-bottom'); // Indicate drop below
            }
        }
    }

    function handleDragLeave(event) {
        // Remove drag-over classes when leaving a list item
         const targetItem = event.target.closest('li');
         if (targetItem) {
             targetItem.classList.remove('drag-over', 'drag-over-bottom');
         }
    }

    function handleDrop(event) {
        event.preventDefault();

        const targetItem = event.target.closest('li');
        if (targetItem && draggedItem && targetItem !== draggedItem) {
            const draggedIndex = parseInt(event.dataTransfer.getData('text/plain'), 10);
            const targetIndex = parseInt(targetItem.dataset.noteIndex, 10);

            // Remove drag-over classes
            document.querySelectorAll('#notesList li').forEach(item => {
                item.classList.remove('drag-over', 'drag-over-bottom');
            });

            // Reorder the notes array
            const [movedNote] = notes.splice(draggedIndex, 1);

            // Determine the correct drop index based on drag-over class
            let dropIndex = targetIndex;
            if (targetItem.classList.contains('drag-over-bottom')) {
                dropIndex = targetIndex + 1;
            }

            notes.splice(dropIndex, 0, movedNote);

            updateNotesList(); // Update the display
            saveStateToLocalStorage(); // Save the new order
        }
         // Ensure drag-over classes are removed even if drop wasn't on a valid target LI
         document.querySelectorAll('#notesList li').forEach(item => {
             item.classList.remove('drag-over', 'drag-over-bottom');
         });
    }

    function handleDragEnd(event) {
         // Clean up the dragging class from the dragged item
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
        }
        draggedItem = null; // Clear the dragged item reference
         // Ensure all drag-over classes are removed at the end of the drag operation
         document.querySelectorAll('#notesList li').forEach(item => {
             item.classList.remove('drag-over', 'drag-over-bottom');
         });
    }


    // --- Image Gallery & Modal ---
    function setupImageHandling() { // Encapsulate setup
        const imageUploadInput = document.getElementById('imageUpload');
        const imageModal = document.getElementById('imageModal');
        if (imageUploadInput) imageUploadInput.addEventListener('change', handleImageUpload);
        if (imageModal) imageModal.addEventListener('click', function(event) { if (event.target === this) closeModal(); });
    }
    function handleImageUpload(event) { /* ... (as before) ... */
        const files = event.target.files;
        if (!files || files.length === 0) return;
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
        if (imageFiles.length === 0 && files.length > 0) {
             alert("❌ يرجى اختيار ملفات صور فقط."); event.target.value = ''; return;
        }
        if (imageFiles.length === 0) return;
        processImageFiles(imageFiles, () => { event.target.value = ''; }); // Process and reset input
    }
    function processImageFiles(files, callback) { // Helper to process files
        const MAX_CONCURRENT_READS = 5; let currentReads = 0; const processQueue = [...files]; let addedCount = 0;
        function processNextFile() {
            if (processQueue.length === 0) { if (currentReads === 0) { if (addedCount > 0) { updateImageGallery(); saveStateToLocalStorage(); } if (callback) callback(); } return; }
            if (currentReads >= MAX_CONCURRENT_READS) return;
            currentReads++; const file = processQueue.shift(); const reader = new FileReader();
            reader.onloadend = () => { if (reader.result && String(reader.result).startsWith('data:image')) { lectureImages.push({ id: Date.now() + '-' + Math.random().toString(16).slice(2), data: reader.result }); addedCount++; } currentReads--; processNextFile(); };
            reader.onerror = (error) => { console.error("FileReader img error:", file.name, error); alert(`❌ خطأ قراءة الصورة: ${file.name}`); currentReads--; processNextFile(); };
            reader.readAsDataURL(file); processNextFile();
        }
        processNextFile();
    }
    function updateImageGallery() { /* ... (as before) ... */
        const gallery = document.getElementById('imageGallery'); gallery.innerHTML = '';
        lectureImages.forEach((imgData, index) => {
            const container = document.createElement('div'); container.className = 'img-container';
            const imgElement = document.createElement('img'); imgElement.src = imgData.data; imgElement.alt = `صورة ${index + 1}`; imgElement.title = `صورة ${index + 1}`; imgElement.onclick = () => openModal(index); imgElement.onerror = () => { imgElement.alt = "خطأ"; imgElement.style.border = "2px solid red";};
            const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = '×'; deleteBtn.className = 'delete-img-btn'; deleteBtn.title = 'حذف'; deleteBtn.onclick = (e) => { e.stopPropagation(); deleteImage(index); };
            container.appendChild(imgElement); container.appendChild(deleteBtn); gallery.appendChild(container);
        });
    }
    function deleteImage(index) { /* ... (as before) ... */
        if (index < 0 || index >= lectureImages.length) return;
        if (confirm(`هل أنت متأكد من حذف هذه الصورة؟`)) { lectureImages.splice(index, 1); updateImageGallery(); saveStateToLocalStorage(); }
    }
    function openModal(index) { /* ... (as before) ... */
        if (index < 0 || index >= lectureImages.length) return;
        currentModalIndex = index; const modal = document.getElementById('imageModal'); const modalImg = document.getElementById('modalImage');
        modalImg.src = lectureImages[currentModalIndex].data; modal.style.display = 'block';
        document.addEventListener('keydown', handleModalKeydown); document.body.style.overflow = 'hidden';
    }
    function closeModal() { /* ... (as before) ... */
        const modal = document.getElementById('imageModal'); modal.style.display = 'none';
        document.removeEventListener('keydown', handleModalKeydown); document.body.style.overflow = '';
    }
    function changeModalImage(step) { /* ... (as before) ... */
        const totalImages = lectureImages.length; if (totalImages === 0) return;
        currentModalIndex = (currentModalIndex + step + totalImages) % totalImages;
        const modalImg = document.getElementById('modalImage');
        if(lectureImages[currentModalIndex]) modalImg.src = lectureImages[currentModalIndex].data; else closeModal();
    }
    function handleModalKeydown(event) { /* ... (as before) ... */
        if (document.getElementById('imageModal').style.display !== 'block') { document.removeEventListener('keydown', handleModalKeydown); return; }
        switch (event.key) { case 'Escape': closeModal(); break; case 'ArrowLeft': changeModalImage(-1); break; case 'ArrowRight': changeModalImage(1); break; }
    }

    // --- Dark Mode ---
    function toggleDarkMode() { /* ... (as before) ... */
        document.body.classList.toggle("dark-mode");
        const isDarkMode = document.body.classList.contains("dark-mode");
        localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
        renderMathInElement(document.getElementById('summaryContent')); // Target inner div
        renderMathInElement(document.getElementById('notesList'));
    }

    // --- State Persistence (LocalStorage) ---
    const LOCAL_STORAGE_KEY = 'youtubeVideoSummarizerState_v2'; // Updated key for new version

    function saveStateToLocalStorage() {
        clearTimeout(window.saveTimeout);
        window.saveTimeout = setTimeout(() => {
             try {
                const state = {
                    notes: notes,
                    lectureImages: lectureImages, // WARNING: Large data!
                    transcript: document.getElementById('transcriptInput')?.value || '',
                    summary: document.getElementById('summaryContent')?.innerHTML || '', // Save inner div content
                    videoUrl: currentVideoUrl // Save the current video URL
                };
                const stateString = JSON.stringify(state);
                localStorage.setItem(LOCAL_STORAGE_KEY, stateString);
                console.log("State saved to LocalStorage.");
            } catch (error) {
                 console.error("Error saving state to LocalStorage:", error);
                 // Consider adding an alert here if QuotaExceededError occurs frequently
                 if (error.name === 'QuotaExceededError') {
                     console.warn("LocalStorage quota exceeded. Data might not be saved correctly.");
                     // alert("تحذير: مساحة التخزين المحلية ممتلئة. قد لا يتم حفظ جميع البيانات.");
                 }
            }
        }, 500);
    }

    function loadStateFromLocalStorage() {
         try {
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedState) {
                const state = JSON.parse(savedState);
                console.log("Loading state from LocalStorage.");
                notes = state.notes || [];
                lectureImages = state.lectureImages || [];
                document.getElementById('transcriptInput').value = state.transcript || '';
                const summaryContainer = document.getElementById('summaryContent');
                if (summaryContainer) {
                   summaryContainer.innerHTML = state.summary || '🔍 لم يتم توليد ملخص بعد.';
                }
                currentVideoUrl = state.videoUrl || ''; // Load the video URL
                document.getElementById("videoUrl").value = currentVideoUrl; // Put it in the input field


                updateNotesList(); // Update notes display with loaded data
                updateImageGallery(); // Update image display with loaded data
                renderMathInElement(document.getElementById('summaryContent')); // Render math in loaded summary
                renderMathInElement(document.getElementById('notesList')); // Render math in loaded notes (if any)

            } else { console.log("No saved state found."); }
         } catch (error) { console.error("Error loading state:", error); }
        // Load dark mode preference
        const darkModePref = localStorage.getItem('darkMode');
        if (darkModePref === 'enabled' && !document.body.classList.contains('dark-mode')) { document.body.classList.add("dark-mode"); }
        else if (darkModePref === 'disabled' && document.body.classList.contains('dark-mode')) { document.body.classList.remove("dark-mode"); }
    }

    // --- Export/Import Data (Modified for Video URL) ---
    function exportData() {
        try {
            const state = {
                notes: notes,
                lectureImages: lectureImages,
                transcript: document.getElementById('transcriptInput').value,
                summary: document.getElementById('summaryContent').innerHTML,
                videoUrl: currentVideoUrl // Include video URL in export
            };
            const stateString = JSON.stringify(state, null, 2);
            const blob = new Blob([stateString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lecture_data_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log("Data exported successfully.");
        } catch (error) {
            console.error("Error exporting data:", error);
            alert("❌ حدث خطأ أثناء محاولة تصدير البيانات.");
        }
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        notes = importedState.notes || [];
                        lectureImages = importedState.lectureImages || [];
                        document.getElementById('transcriptInput').value = importedState.transcript || '';
                        document.getElementById('summaryContent').innerHTML = importedState.summary || '🔍 لم يتم توليد ملخص بعد.';
                        currentVideoUrl = importedState.videoUrl || ''; // Import video URL
                        document.getElementById("videoUrl").value = currentVideoUrl; // Put it in the input field

                        updateNotesList();
                        updateImageGallery();
                        renderMathInElement(document.getElementById('summaryContent'));
                        renderMathInElement(document.getElementById('notesList'));
                        saveStateToLocalStorage();
                        console.log("Data imported successfully.");

                        // Automatically load the video if a URL was imported
                        if(currentVideoUrl) {
                             // Add a small delay to ensure the DOM is fully ready for the player div
                            setTimeout(() => loadVideo(currentVideoUrl), 100);
                        } else {
                             // If no video URL was imported, clear the video player area
                             if (player && typeof player.destroy === 'function') {
                                try { player.destroy(); player = null; } catch (e) { console.error("Error destroying player after import:", e); }
                            }
                             document.getElementById("videoContainer").innerHTML = '<p class="center-text" style="padding: 20px; color: #6c757d;">أدخل رابط فيديو يوتيوب واضغط "تشغيل الفيديو" للبدء.</p>';
                        }

                    } catch (error) {
                        console.error("Error importing data:", error);
                        alert("❌ حدث خطأ أثناء محاولة استيراد البيانات. تأكد من أن الملف صحيح.");
                    }
                };
                reader.onerror = (error) => {
                    console.error("Error reading file:", error);
                    alert("❌ حدث خطأ أثناء قراءة الملف.");
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }

    // --- Toggle Floating Note Button ---
    function toggleFloatingNoteButton() {
        const button = document.getElementById('floatingNoteButton');
        if (button.style.display === 'none' || button.style.display === '') {
            button.style.display = 'block';
        } else {
            button.style.display = 'none';
        }
    }

    function toggleNotesSection() {
        const notesSection = document.querySelector('.notes-section');
        if (notesSection) {
            // This function currently scrolls to the notes section, adjust if needed for fullscreen
            notesSection.scrollIntoView({ behavior: 'smooth' });
        }
    }

    // --- Download Page ---
     function downloadPage() {
        try {
            console.log("Preparing page HTML for saving...");
            const clonedDoc = document.documentElement.cloneNode(true);

             // Update dynamic content in the cloned document
             // Note: Video iframe cannot be reliably cloned/saved directly due to security and complexity.
             // The saved HTML will include the video URL input value and placeholders, but not the active player.
            const clonedVideoUrlInput = clonedDoc.querySelector('#videoUrl');
            if(clonedVideoUrlInput) clonedVideoUrlInput.value = document.getElementById('videoUrl').value;

            const clonedTranscript = clonedDoc.querySelector('#transcriptInput');
            if (clonedTranscript) clonedTranscript.textContent = document.getElementById('transcriptInput').value;

            const clonedNoteText = clonedDoc.querySelector('#noteText');
            if(clonedNoteText) clonedNoteText.textContent = document.getElementById('noteText').value;

            const clonedSummaryContent = clonedDoc.querySelector('#summaryContent');
            if(clonedSummaryContent) clonedSummaryContent.innerHTML = document.getElementById('summaryContent').innerHTML;

             // Rebuild notes list in the cloned document (without drag handles or buttons)
             const clonedNotesList = clonedDoc.querySelector('#notesList');
             if(clonedNotesList) {
                  clonedNotesList.innerHTML = ''; // Clear clone
                  notes.forEach((note) => {
                    let listItem = document.createElement("li");
                    // Simpler structure for saved HTML
                    let contentHTML = `<b>[${formatTime(note.time)}]</b> `;
                    if (note.type === 'text') {
                         contentHTML += note.text;
                    } else if (note.type === 'audio') {
                       // Embed audio data if available
                       contentHTML += `ملاحظة صوتية: <audio controls src="${note.data || ''}"></audio>`;
                    }
                    // Do NOT add drag handles or buttons in the saved HTML
                    listItem.innerHTML = contentHTML;
                    clonedNotesList.appendChild(listItem);
                  });
             }


             // Rebuild image gallery in the cloned document (simple images)
            const clonedImageGallery = clonedDoc.querySelector('#imageGallery');
            if(clonedImageGallery) {
                clonedImageGallery.innerHTML = '';
                lectureImages.forEach((imgData) => {
                    const imgElement = document.createElement('img'); imgElement.src = imgData.data; imgElement.alt = `صورة`;
                    // Include basic styles for the saved file
                    imgElement.style.cssText = 'display: inline-block; width: 120px; height: 120px; object-fit: cover; margin: 5px; border: 1px solid #ccc;';
                    clonedImageGallery.appendChild(imgElement);
                });
            }

            // Remove elements not needed in the saved file (buttons, inputs, scripts, modals, etc.)
            const selectorsToRemove = [
                '.floating-controls', '.floating-right-controls', '#recordNoteBtn', '#recordingStatus', '#imageUpload',
                'label[for="imageUpload"]', '#downloadPageBtn', '#notesList button', '#imageGallery .delete-img-btn',
                '#imageModal', 'script[src*="https://www.youtube.com/iframe_api"]', '#playerStatus', '.search-box button', '.search-box input', '.search-box #searchResults',
                 '.speed-controls', '.button-container button:not(#downloadPageBtn):not(#exportBtn):not(#importBtn):not(#toggleFloatingNoteBtn)', // Keep Export/Import/Toggle Floating Note buttons
                 '#resetPageBtn', // Remove the reset button from the saved file
                 'script:last-of-type', // Remove the main inline script itself
                  '.drag-handle' // Remove drag handles
            ];
             selectorsToRemove.forEach(selector => { clonedDoc.querySelectorAll(selector).forEach(el => el.remove()); });

              // Add a meta tag description for the saved file
             const head = clonedDoc.querySelector('head');
             if(head) {
                  const meta = document.createElement('meta'); meta.name = "description";
                  meta.content = "نسخة محفوظة من صفحة الملاحظات. تحتوي على ملاحظات وصور ومحتوى فيديو مضمن (إذا كان موجودًا)."; head.appendChild(meta);
             }

             // Set video container content to the video URL input value
             const clonedVideoContainer = clonedDoc.querySelector('#videoContainer');
             if(clonedVideoContainer) {
                 clonedVideoContainer.innerHTML = `<p class="center-text" style="padding: 20px; color: #6c757d;">رابط الفيديو الأصلي: ${document.getElementById('videoUrl').value || 'غير محدد'}</p>`;
             }


            const finalHtml = "<!DOCTYPE html>\n" + clonedDoc.outerHTML;
            const blob = new Blob([finalHtml], { type: 'text/html;charset=UTF-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            let filename = "lecture_page_saved.html"; // Default filename
            try {
                 const videoTitle = (player && typeof player.getVideoData === 'function' && player.getVideoData().title) ? player.getVideoData().title : '';
                 if (videoTitle) filename = videoTitle.replace(/[^a-z0-9\u0600-\u06FF\s]/gi, '_').replace(/\s+/g, '_').substring(0, 50) + ".html";
                 else if (currentVideoUrl) filename = 'video_notes_' + extractVideoID(currentVideoUrl) + '.html';
            } catch (e) { console.error("Error generating filename:", e); }
            a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            console.log("Page HTML saved as:", filename);
        } catch (error) {
            console.error("Error saving page HTML:", error);
            alert("❌ حدث خطأ أثناء محاولة حفظ الصفحة كـ HTML.");
        }
    }


    // --- Reset Page Function ---
    function resetPage() {
        if (confirm("هل أنت متأكد أنك تريد إعادة تعيين الصفحة؟ سيؤدي هذا إلى مسح جميع الملاحظات والصور والبيانات المحفوظة.")) {
            resetAppState(true); // Pass true to clear notes and images too
            notes = []; // Ensure notes array is empty
            lectureImages = []; // Ensure images array is empty
            currentVideoUrl = ''; // Clear stored video URL

            // Clear input fields and displays
            document.getElementById("videoUrl").value = "";
            document.getElementById("noteText").value = "";
            document.getElementById("transcriptInput").value = "";
            document.getElementById("summaryContent").innerHTML = "🔍 لم يتم توليد ملخص بعد.";
            document.getElementById("searchResults").innerHTML = "";

            updateNotesList(); // Clear notes display
            updateImageGallery(); // Clear image display

            // Stop and clear video player
             if (player && typeof player.destroy === 'function') {
                try { player.destroy(); player = null; } catch (e) { console.error("Error destroying player on reset:", e); }
            }
             document.getElementById("videoContainer").innerHTML = '<p class="center-text" style="padding: 20px; color: #6c757d;">أدخل رابط فيديو يوتيوب واضغط "تشغيل الفيديو" للبدء.</p>';

             // Clear local storage
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            console.log("LocalStorage state cleared.");

            alert("✅ تم إعادة تعيين الصفحة بنجاح.");
        }
    }

    // --- Initial Load & Reset ---
     function resetAppState(clearAll = false) { // Function to clear dynamic content
        // This function now primarily clears text areas, summary, and search results.
        // Notes, images, and video URL clearing are handled in resetPage.
        document.getElementById("transcriptInput").value = "";
        document.getElementById("summaryContent").innerHTML = "🔍 لم يتم تولخص بعد."; // Target inner div
        document.getElementById("searchResults").innerHTML = "";
        document.getElementById("searchText").value = "";
        document.getElementById("clearSearchBtn").style.display = 'none';

        isPlaying = false; updatePlayPauseButton();
        console.log(`App state partially reset. Clear All (notes/images): ${clearAll}.`);
    }


    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM ready.");
        loadStateFromLocalStorage(); // Load state first to get video URL and notes/images
        loadYouTubeAPI(); // Load API, onReady will handle video if URL is present
        setupImageHandling(); // Setup listeners for image upload/modal
        updatePlayPauseButton(); // Set initial button state correctly

        // Initial render of notes from loaded state
        updateNotesList();
    });

  </script>
</body>
</html>